{#
 Copyright 2022 Jo-Philipp Wich <jo@mein.io>
 Licensed to the public under the Apache License 2.0.
-#}

{%
	include(`themes/${theme}/header`);
-%}

<script src="{{ resource }}/luci.js?v=25.017.24510~d42ec55"></script>
<script src="{{ resource }}/sweetalert2.all.min.js"></script>
<script>
	L = new LuCI({{ replace(`${ {
		media          : media,
		resource       : resource,
		scriptname     : http.getenv("SCRIPT_NAME"),
		pathinfo       : http.getenv("PATH_INFO"),
		documentroot   : http.getenv("DOCUMENT_ROOT"),
		requestpath    : ctx.request_path,
		dispatchpath   : ctx.path,
		pollinterval   : +config.main.pollinterval || 5,
		ubuspath       : config.main.ubuspath || '/ubus/',
		sessionid      : ctx.authsession,
		token          : ctx.authtoken,
		nodespec       : dispatched,
		apply_rollback : max(+config.apply.rollback ||  90, 90),
		apply_holdoff  : max(+config.apply.holdoff  ||   4,  1),
		apply_timeout  : max(+config.apply.timeout  ||   5,  1),
		apply_display  : max(+config.apply.display  || 1.5,  1),
		rollback_token : rollback_token
	} }`, '/', '\\/') }});
</script>

<style>
    .update-info {
        text-align: left;
        margin: 15px 0;
        font-family: Arial, sans-serif;
    }

    .update-info p {
        margin: 8px 0;
        color: #333;
    }
    
    .changelog {
        font-family: Arial, sans-serif;
        font-size: 14px;
        color: #333;
        line-height: 1.6;
        margin-top: 20px;
        padding: 10px;
        border-left: 4px solid #007BFF;
        max-height: 250px;
        overflow-y: auto;
        border-radius: 5px;
    }

    .changelog pre {
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.5;
    }

    .swal2-popup {
        font-family: Arial, sans-serif;
        max-width: 600px;
    }

    .swal2-title {
        font-size: 1.6em;
        margin-bottom: 15px;
        color: #007BFF;
    }

    .swal2-html-container a {
        text-decoration: none;
        color: #007BFF;
    }

    .swal2-html-container a:hover {
        text-decoration: underline;
    }

    .square-wrapper {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1000;
    }
    .square {
        border: 1px solid #5e42a6;
        height: 26px;
        width: 26px;
        display: block;
        transform: rotate(45deg);
        overflow: hidden;
        cursor: pointer;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square .burgerwrap {
        height: 18px;
        width: 21px;
        transform: rotate(-45deg);
        padding-left: 2px;
        padding-top: 8px;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square:hover {
        transform: rotate(135deg);
        border: 1px solid rgb(61, 14, 230);
    }
    .square:hover .burgerwrap {
        transform: rotate(-135deg);
    }
    .square span {
        height: 2px;
        width: 14px;
        background: linear-gradient(145deg, #5e42a6, #b46be4);
        display: block;
        margin-bottom: 2px;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square span:after {
        content: "";
        height: 2px;
        width: 14px;
        position: absolute;
        background: rgb(61, 14, 230);
        left: -22px;
        margin-top: -4px;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square:hover span {
        margin-left: 26px;
    }
    .square:hover span:after {
        left: 0.2px;
    }
    .square span:nth-of-type(1),
    .square span:nth-of-type(1):after {
        transition-delay: 0.1s;
    }
    .square span:nth-of-type(2),
    .square span:nth-of-type(2):after {
        transition-delay: 0.2s;
    }
    .square span:nth-of-type(3),
    .square span:nth-of-type(3):after {
        transition-delay: 0.3s;
    }
</style>

<script>
// ====== Constants ======
const GITHUB_URL = 'https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/main/informasi.txt';
const CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes
let checkTimer;

const cache = {
    content: localStorage.getItem('lastInformation') || '',
    lastUpdate: localStorage.getItem('lastUpdate') || ''
};

// ====== Utility Functions ======
async function fetchText(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch: ${url} (Status: ${response.status})`);
        return await response.text();
    } catch (error) {
        console.error(`Error fetching ${url}:`, error);
        return null;
    }
}

function saveToLocal(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch (error) {
        console.error(`Error saving to localStorage: ${error}`);
        return false;
    }
}

function showAlert({ title, html, icon = 'info', confirmText = 'OK', denyText = 'Nanti', cancelText = 'Tutup', onConfirm, onDeny }) {
    Swal.fire({
        title,
        html,
        icon,
        width: 400,
        confirmButtonText: confirmText,
        showDenyButton: !!onDeny,
        denyButtonText: denyText,
        showCancelButton: !!cancelText,
        cancelButtonText: cancelText,
        customClass: { popup: 'animated fadeInDown' },
        draggable: true,
        allowOutsideClick: false,
        backdrop: 'rgba(0,0,123,0.4)'
    }).then(result => {
        if (result.isConfirmed && onConfirm) onConfirm();
        if (result.isDenied && onDeny) onDeny();
    });
}

// ====== Update & Information Check ======
async function checkForUpdates() {
    const currentVersion = "openwrt_24.10.0-05022025";
    const today = new Date().toISOString().slice(0, 10);
    const lastShownUpdate = localStorage.getItem('mdl_update');

    if (lastShownUpdate === today) return;

    try {
        const [latestVersion, changelogRaw] = await Promise.all([
            fetchText('https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/main/latestversion.txt'),
            fetchText('https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/main/CHANGELOG.md')
        ]);

        if (latestVersion && latestVersion.trim() !== currentVersion) {
            const changelogMatch = changelogRaw.match(/\*\*Changelog\*\* \((.*?)\)\n([\s\S]*?)(?=\*\*Changelog\*\*|$)/);
            const changelogFormatted = changelogMatch 
                ? `<strong>Changelog (${changelogMatch[1]})</strong><p>${changelogMatch[2].trim().replace(/-\s/g, 'â€¢ ').replace(/\n/g, '<br>')}</p>`
                : 'Tidak ada catatan perubahan.';

            showAlert({
                title: 'ðŸš€ Update Tersedia!',
                html: `
                        <div class="update-info" style="text-align: center;">
                            <img alt="Current Version" width="155" height="30" src="https://img.shields.io/badge/${currentVersion}-x?style=for-the-badge&logo=openwrt&color=blue">
                            <img alt="Latest Version" width="155" height="30" src="https://img.shields.io/badge/${latestVersion}-x?style=for-the-badge&logo=openwrt&color=green">
                            <div class="changelog" style="margin-top: 15px; text-align: left;">
                                <h4 style="color: #007BFF;">ðŸ“‹ Changelog:</h4>
                                <div>${changelogFormatted}</div>
                            </div>
                        </div>
                `,
                confirmText: 'ðŸ”„ Update',
                denyText: 'â³ Nanti',
                cancelText: 'âŒ Batal',
                onConfirm: () => window.location.href = 'https://github.com/rizkikotet-dev/RTA-WRT/releases/latest',
                onDeny: () => saveToLocal('mdl_update', today)
            });
        }
    } catch (error) {
        console.error('Error checking for updates:', error);
    }
}

async function checkInformation(retryCount = 0) {
    const MAX_RETRIES = 3;

    try {
        const githubContent = await fetchText(GITHUB_URL);
        if (githubContent && githubContent !== cache.content) {
            const title = 'ðŸš€ Informasi';
            showAlert({
                title,
                html: `
                <div class="changelog" style="margin-top: 15px; text-align: left; white-space: pre-line;">
                    <div>${githubContent}</div>
                </div>
                `,
                icon: cache.content ? 'info' : 'success',
                confirmText: 'Mengerti',
                cancelText: 'âŒ Tutup',
                onConfirm: () => {
                    if (saveToLocal('lastInformation', githubContent)) {
                        cache.content = githubContent;
                        cache.lastUpdate = new Date().toISOString();
                        console.log('Informasi diperbarui.');
                    }
                }
            });
        }
    } catch (error) {
        console.warn(`Check error: ${error}`);
        if (retryCount < MAX_RETRIES) {
            const retryDelay = Math.pow(2, retryCount) * 1000;
            console.log(`Mencoba kembali dalam ${retryDelay / 1000} detik...`);
            setTimeout(() => checkInformation(retryCount + 1), retryDelay);
        }
    }
}

// ====== Event About ======
function showProfile() {
    Swal.fire({
      width: 400,
      title: "About Me!",
      text: "Halo! Saya Rizki Kotet, seorang programmer pemula yang belajar C# dan PHP. Saya memiliki pemahaman dasar tentang front-end dan back-end. Saat ini, saya sedang mengerjakan proyek Custom OpenWrt dan ImmortalWrt. Saya selalu bersemangat untuk belajar hal baru di dunia teknologi!",
      imageUrl: "{{ resource }}/Profile.jpeg",
      imageWidth: 200,
      imageHeight: 200,
      imageAlt: "Custom image",
      draggable: true,
      allowOutsideClick: false,
      footer: `
        <p style="text-align: center;">
            <a href="https://t.me/rtawrt"><img alt="Channel" src="{{ resource }}/Channel.svg" width="110" height="30"></a>
            <a href="https://t.me/backup_rtawrt"><img alt="Group" src="{{ resource }}/Group.svg" width="110" height="30"></a>
            <a href="https://t.me/RizkiKotet"><img alt="Personal" src="{{ resource }}/Personal.svg" width="110" height="30"></a>
        </p>
      `
    });
}

// ====== Periodic Checker Initialization ======
function initializeChecker() {
    checkInformation();
    if (checkTimer) clearInterval(checkTimer);
    checkTimer = setInterval(checkInformation, CHECK_INTERVAL);
}

// ====== Event Listeners ======
document.addEventListener('DOMContentLoaded', () => {
    checkForUpdates();
    initializeChecker();
});

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        initializeChecker();
    } else {
        clearInterval(checkTimer);
    }
});

window.addEventListener('online', initializeChecker);
window.addEventListener('offline', () => clearInterval(checkTimer));
</script>

<div class="square-wrapper">
    <div class="square" onclick="showProfile()">
        <div class="burgerwrap">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>