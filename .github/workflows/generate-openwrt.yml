name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      releases_branch:
        description: "Select the releases branch"
        required: true
        default: "openwrt:24.10.0"
        type: choice
        options:
          - openwrt:24.10.0
          - openwrt:23.05.5
          - immortalwrt:24.10.0-rc4
          - immortalwrt:23.05.4
      devices:
        description: "Select device target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - s905x
          - s905x2
          - s905x3
          - s905x4
          - s912
          - h5-orangepi-zeroplus2
          - h5-orangepi-zeroplus
          - h5-orangepi-prime
          - h5-orangepi-pc2
          - h6-orangepi-lite2
          - h6-orangepi-1plus
          - h6-orangepi-3
          - h6-orangepi-3lts
          - h616-orangepi-zero2
          - h618-orangepi-zero2w
          - h618-orangepi-zero3
          - rk3566-orangepi-3b
          - rk3588s-orangepi-5
          - bcm2710-rpi-3b
          - bcm2711-rpi-4b
          - x86-64
      notify:
        description: "Notify to Telegram"
        required: true
        default: false
        type: boolean

env:
  TZ: Asia/Jakarta
  IMAGEBUILDER_SH: imagebuilder.sh
  DEBIAN_FRONTEND: noninteractive
  APT_PACKAGES: build-essential libncurses5-dev zlib1g-dev gawk git gettext libssl-dev rsync wget unzip tar gzip qemu-utils mkisofs jq python3 python3-pip
  CURRENT_BRANCH: ${{ github.ref_name }}

jobs:
  prebuild:
    runs-on: ubuntu-latest
    outputs:
      devices: ${{ steps.matrix.outputs.devices }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Configure Build Matrix
        id: matrix
        run: |
          set -euxo pipefail
          if [ "${{ inputs.devices }}" = "all" ]; then
            devices=$(jq -nc '[ "s905x", "s905x2", "s905x3", "s905x4", "s912", "h5-orangepi-zeroplus2", "h5-orangepi-zeroplus", "h5-orangepi-prime", "h5-orangepi-pc2", "h6-orangepi-lite2", "h6-orangepi-1plus", "h6-orangepi-3", "h6-orangepi-3lts", "h616-orangepi-zero2", "h618-orangepi-zero2w", "h618-orangepi-zero3", "rk3566-orangepi-3b", "rk3588s-orangepi-5", "bcm2710-rpi-3b", "bcm2711-rpi-4b", "x86-64" ]')
          else
            devices=$(jq -nc --arg d "${{ inputs.devices }}" '[$d]')
          fi
          echo "devices=$devices" >> $GITHUB_OUTPUT

  build:
    needs: prebuild
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        devices: ${{ fromJSON(needs.prebuild.outputs.devices) }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Install Dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y ${{ env.APT_PACKAGES }}

      - name: Add changelog info
        id: changelog
        run: |
          r=$(awk '/^\*\*Changelog\*\*/ {if(found) exit; found=1} found' ${PWD}/CHANGELOG.md)
          r="${r//'%'/'%25'}"
          r="${r//$'\n'/'%0A'}"
          r="${r//$'\r'/'%0D'}"
          echo "changelog=$r" >> $GITHUB_OUTPUT

      - name: Setup Environment
        id: environment
        run: |
          set -euxo pipefail
          sudo timedatectl set-timezone "$TZ"
          echo "datetime=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "openwrt_version=${{ inputs.releases_branch }}" >> $GITHUB_ENV
          echo "openwrt_tag=$(echo "${{ inputs.releases_branch }}" | tr ':' '_')" >> $GITHUB_ENV

      - name: Build Image
        id: imagebuilder
        run: |
          set -euxo pipefail
          echo "Building for ${{ matrix.devices }}"
          chmod +x ${IMAGEBUILDER_SH}
          if sudo bash ${IMAGEBUILDER_SH} ${{ env.openwrt_version }} "${{ matrix.devices }}"; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Release
        if: ${{ steps.imagebuilder.outputs.status == 'success' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: imagebuilder/out_firmware/*
          tag: ${{ env.openwrt_tag }}-${{ env.datetime }}
          release_name: RTA-WRT - ${{ env.openwrt_tag }}-${{ env.datetime }}
          overwrite: true
          prerelease: ${{ github.ref_name == 'dev' }}
          promote: ${{ github.ref_name != 'dev' }}
          body: |
            ---

            # ðŸš€ **RTA-WRT - Image Information**
              
            ---
              
            ### ðŸ“¥ **Download Statistics**
              
            ![GitHub Downloads](https://img.shields.io/github/downloads/rizkikotet-dev/RTA-WRT/${{ needs.prebuild.outputs.openwrt_tag }}-${{ needs.prebuild.outputs.datetime }}/total?style=for-the-badge&logo=Openwrt)
              
            ---
              
            ### ðŸ“¢ **Telegram Support**
              
            [![Channel](https://img.shields.io/badge/Telegram-Channel-%23059dfa?style=for-the-badge&logo=Telegram&link=https%3A%2F%2Ft.me%2Frtawrt)](https://t.me/rtawrt)
            [![Group](https://img.shields.io/badge/Telegram-Group-%23059dfa?style=for-the-badge&logo=Telegram&link=https%3A%2F%2Ft.me%2Fbackup_rtawrt)](https://t.me/backup_rtawrt)
            [![Personal](https://img.shields.io/badge/Telegram-Personal-%23059dfa?style=for-the-badge&logo=Telegram&link=https%3A%2F%2Ft.me%2FRizkiKotet)](https://t.me/RizkiKotet)
              
            ---
              
            ### ðŸ“ **Changelog**

            ${{ needs.prebuild.outputs.changelog }}
              
            ---
              
            ## âš ï¸ Peringatan untuk Instalasi Pertama
            > **Catatan:** Booting awal memerlukan waktu agak lama karena proses partisi ulang dan konfigurasi tambahan.

            ---

            ## ðŸ“± Device yang Didukung

            ### Amlogic
            - **s905x** (HG680P, B860Hv1/v2) | Mod Boot SDCARD
            - **s905x2** (HG680FJ, B860Hv5, MNC CYBORG001, X96Max-4G, X96Max-2G, MECOOL-KM3-4G, Tanix-Tx5-Max, A95X-F2)
            - **s905x3** (X96-Max+, HK1-Box, Vontar-X3, H96-Max-X3, Ugoos-X3, TX3(QZ), TX3(BZ), X96-Air, X96-Max+_A100, A95X-F3-Air, Tencent-Aurora-3Pro(s905x3-b), X96-Max+Q1, X96-Max+100W, X96-Max+_2101, Infinity-B32, Whale, X88-Pro-X3, X99-Max-Plus, Transpeed-X3-Plus)
            - **s905x4** (AKARI AX810, dll)
            - **s912** (Tanix-TX8-Max, Tanix-TX9-Pro(3G), Tanix-TX9-Pro(2G), Tanix-TX92, Nexbox-A1, Nexbox-A95X-A2, A95X, H96-Pro-Plus, VORKE-Z6-Plus, Mecool-M8S-PRO-L, Vontar-X92, T95Z-Plus, Octopus-Planet, Phicomm-T1, TX3-Mini, OneCloudPro-V1.1_V1.2)

            ### Allwinner
            - **H5** (Orange Pi Zero Plus 2, Orange Pi Zero Plus, Orange Pi Prime, Orange Pi PC2)
            - **H6** (Orange Pi 1 Plus, Orange Pi Lite 2, Orange Pi 3 LTS, Orange Pi 3)
            - **H616** (Orange Pi Zero 2)
            - **H618** (Orange Pi Zero 3, Orange Pi Zero 2W)

            ### Rockchip
            - **RK3566** (Orange Pi 3B)
            - **RK3588S** (Orange Pi 5)
            - **RK3588** (Orange Pi 5 Plus)

            ### Broadcom
            - **BCM2710** (Raspberry Pi 3A+/3B/3B+/CM3/Zero2/Zero2W - 64bit)
            - **BCM2711** (Raspberry Pi 4B/400/CM4 - 64bit)

            ### Generic
            - **x86-64**

            ---

            ## â„¹ï¸ Informasi Sistem
            - **IP Default:** 192.168.1.1
            - **Username:** root
            - **Password:** rtawrt
            - **SSID:** RTA-WRT_2g / RTA-WRT_5g

            ### â­ Fitur Utama
            - Modemmanager dengan koneksi ulang otomatis
            - OpenClash dengan MetaCubeX Mihomo terbaru
            - Passwall *Tunneling* alternatif
            - MihomoTProxy *Tunneling* alternatif
            - TinyFm file manager
            - Internet Detector dan Lite Watchdog
            - Tema Argon & Material dengan tampilan login kustom
            - 3ginfo lite, Modeminfo, sms-tool, dan aplikasi modem lainnya
            - Dukungan Layar OLED (teruji di Raspberry Pi 4B)

            ---
              
            **ðŸš€ Tetap terhubung, nikmati performa maksimal dengan RTA-WRT! ðŸš€**
              
            ---


  opsional:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ inputs.notify == 'true' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Install Dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y ${{ env.APT_PACKAGES }}

      - name: Add changelog info
        id: changelog
        run: |
          r=$(awk '/^\*\*Changelog\*\*/ {if(found) exit; found=1} found' ${PWD}/CHANGELOG.md)
          r="${r//'%'/'%25'}"
          r="${r//$'\n'/'%0A'}"
          r="${r//$'\r'/'%0D'}"
          echo "changelog=$r" >> $GITHUB_OUTPUT

      - name: Change Branch
        uses: actions/checkout@v4
        with:
          ref: info

      - name: Setup Environment
        id: environment
        run: |
          set -euxo pipefail
          sudo timedatectl set-timezone "$TZ"
          echo "datetime=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "openwrt_version=${{ inputs.releases_branch }}" >> $GITHUB_ENV
          echo "openwrt_tag=$(echo "${{ inputs.releases_branch }}" | tr ':' '_')" >> $GITHUB_ENV

      - name: Update Branch Info
        id: update
        run: |
          echo "${{ steps.changelog.outputs.changelog }}" > ${CURRENT_BRANCH}/changelog.txt
          echo "${{ env.openwrt_tag }}--$( [ "$CURRENT_BRANCH" == "main" ] && echo "main" || echo "dev" )" > $CURRENT_BRANCH/version.txt
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add . || echo "No files to commit"
          git commit -m "Auto Release: v${{ env.openwrt_version }}" || echo "No changes to commit"
          git push || echo "Error pushing to GitHub"

      - name: Notify Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          GROUP_ID: ${{ secrets.CHAT_ID }}
          MESSAGE_THREAD_ID: 36
        run: |
          FORMATTER='s/([_*[\]()~`>#+=|{}.!])/\\\\1/g'
          
          MESSAGE_STABLE=$(cat << EOF
          ðŸŽ¯ *RTA\-WRT Firmware Update*
          âœ… _Stable Release_

          ðŸ”¹ *Versi:* \`${{ env.openwrt_version }}\`
          ðŸ”¹ *Tanggal:* \`${{ env.datetime }}\`

          ðŸ“Œ *Catatan:*
          ðŸ”’ Versi stabil dengan peningkatan keamanan dan performa\!
          ðŸ“¢ Disarankan untuk semua pengguna agar mendapatkan pengalaman terbaik\!
          EOF
          )

          MESSAGE_DEV=$(cat << EOF
          ðŸš€ *RTA\-WRT Firmware Update*
          ðŸŒŸ _Development Release_

          ðŸ”¹ *Versi:* \`${{ env.openwrt_version }}\`
          ðŸ”¹ *Tanggal:* \`${{ env.datetime }}\`

          ðŸ“Œ *Catatan:*
          ðŸ”¥ Pastikan untuk mencadangkan konfigurasi sebelum pembaruan\!
          ðŸ”„ Selalu gunakan versi terbaru untuk performa terbaik\!
          EOF
          )

          BUTTONS_STABLE='{
              "inline_keyboard": [
                  [
                      {"text": "ðŸ“¥ Unduh Firmware", "url": "https://github.com/rizkikotet-dev/RTA-WRT/releases/latest"},
                      {"text": "ðŸ“– Changelog", "url": "https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/info/main/changelog.txt"}
                  ]
              ]
          }'

          BUTTONS_DEV='{
              "inline_keyboard": [
                  [
                      {"text": "ðŸ“¥ Unduh Firmware", "url": "https://github.com/rizkikotet-dev/RTA-WRT/releases"},
                      {"text": "ðŸ“– Changelog", "url": "https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/info/dev/changelog.txt"}
                  ]
              ]
          }'

          if [ "${{ env.CURRENT_BRANCH }}" == "main" ]; then
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d "chat_id=$GROUP_ID" \
              -d "text=$(echo "$MESSAGE_STABLE" | sed -E "$FORMATTER")" \
              -d "parse_mode=MarkdownV2" \
              -d "reply_markup=$BUTTONS_STABLE" \
              -d "message_thread_id=$MESSAGE_THREAD_ID" || exit 1
          else
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d "chat_id=$GROUP_ID" \
              -d "text=$(echo "$MESSAGE_DEV" | sed -E "$FORMATTER")" \
              -d "parse_mode=MarkdownV2" \
              -d "reply_markup=$BUTTONS_DEV" \
              -d "message_thread_id=$MESSAGE_THREAD_ID" || exit 1
          fi