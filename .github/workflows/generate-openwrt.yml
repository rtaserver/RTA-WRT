name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      releases_branch:
        description: "Select the releases branch"
        required: true
        default: "openwrt:24.10.0"
        type: choice
        options:
          - openwrt:24.10.0
          - openwrt:23.05.5
          - immortalwrt:24.10.0-rc4
          - immortalwrt:23.05.4
      devices:
        description: "Select device target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - s905x
          - s905x2
          - s905x3
          - s905x4
          - s912
          - h5-orangepi-zeroplus2
          - h5-orangepi-zeroplus
          - h5-orangepi-prime
          - h5-orangepi-pc2
          - h6-orangepi-lite2
          - h6-orangepi-1plus
          - h6-orangepi-3
          - h6-orangepi-3lts
          - h616-orangepi-zero2
          - h618-orangepi-zero2w
          - h618-orangepi-zero3
          - rk3566-orangepi-3b
          - rk3588s-orangepi-5
          - bcm2710-rpi-3b
          - bcm2711-rpi-4b
          - x86-64
      notify:
        description: "Notify to Telegram"
        required: true
        default: false
        type: boolean

env:
  TZ: Asia/Jakarta
  IMAGEBUILDER_SH: imagebuilder.sh
  DEBIAN_FRONTEND: noninteractive
  APT_PACKAGES: build-essential libncurses5-dev zlib1g-dev gawk git gettext libssl-dev rsync wget unzip tar gzip qemu-utils mkisofs jq python3 python3-pip

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Configure Build Matrix
        id: devices
        run: |
          if [ "${{ inputs.devices }}" = "all" ]; then
            devices=$(jq -nc '[ "s905x", "s905x2", "s905x3", "s905x4", "s912", "h5-orangepi-zeroplus2", "h5-orangepi-zeroplus", "h5-orangepi-prime", "h5-orangepi-pc2", "h6-orangepi-lite2", "h6-orangepi-1plus", "h6-orangepi-3", "h6-orangepi-3lts", "h616-orangepi-zero2", "h618-orangepi-zero2w", "h618-orangepi-zero3", "rk3566-orangepi-3b", "rk3588s-orangepi-5", "bcm2710-rpi-3b", "bcm2711-rpi-4b", "x86-64" ]')
          else
            devices=$(jq -nc --arg d "${{ inputs.devices }}" '[$d]')
          fi
          echo "devices=$devices" >> "$GITHUB_OUTPUT"

      - name: Setup Telegram Notification
        id: telegram
        run: |
          cat > telegram.sh << 'EOF'
          #!/bin/bash
          BOT_TOKEN="${{ secrets.BOT_TOKEN }}"
          CHAT_ID="${{ secrets.CHAT_ID }}"
          CACHE_DIR="/tmp/telegram_cache"
          mkdir -p "$CACHE_DIR"
  
          case $1 in
              --generate)
                  devices_json="$2"
                  devices_array=($(echo "$devices_json" | jq -r '.[]'))
                  
                  message="=======================%0A"
                  message+="ðŸš€ *RTA-WRT | Build Status*%0A"
                  message+="=======================%0A"
                  message+="ðŸ“Œ *Version*: ${{ inputs.releases_branch }}%0A"
                  message+="ðŸŒ¿ *Branch*: ${{ github.ref_name }}%0A"
                  message+="ðŸ“… *Date*: $(date '+%d-%m-%Y %H:%M:%S')%0A"
                  message+="-----------------------%0A"
                  message+="ðŸ“‹ *Device List*%0A"
                  
                  for device in "${devices_array[@]}"; do
                      message+="ðŸ”¹ $device | â³ Pending%0A"
                  done
                  
                  message+="======================="
                  
                  response=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                      -d "chat_id=$CHAT_ID" \
                      -d "parse_mode=Markdown" \
                      -d "text=$message")
                  
                  message_id=$(echo "$response" | jq -r '.result.message_id')
                  echo "${message//%0A/$'\n'}" > "$CACHE_DIR/message_${message_id}.txt"
                  echo "message_id=$message_id" >> "$GITHUB_OUTPUT"
                  echo "$message_id"
                  ;;
                  
              --update)
                  message_id="$2"
                  device="$3"
                  status="$4"
                  
                  [ -f "$CACHE_DIR/message_${message_id}.txt" ] || exit 1
                  
                  current_message=$(cat "$CACHE_DIR/message_${message_id}.txt")
                  updated_message=$(echo "$current_message" | sed "s/ðŸ”¹ $device |.*$/ðŸ”¹ $device | $status/")
                  echo "$updated_message" > "$CACHE_DIR/message_${message_id}.txt"
                  
                  telegram_message="${updated_message//$'\n'/%0A}"
                  curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/editMessageText" \
                      -d "chat_id=$CHAT_ID" \
                      -d "message_id=$message_id" \
                      -d "parse_mode=Markdown" \
                      -d "text=$telegram_message"
                  ;;
          esac
          EOF
            
          chmod +x telegram.sh
          sudo bash telegram.sh --generate '${{ steps.devices.outputs.devices }}'

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ${{ env.APT_PACKAGES }}

      - name: Setup Environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          echo "datetime=$(date +'%d%m%Y')" >> $GITHUB_ENV
          echo "openwrt_version=${{ inputs.releases_branch }}" >> $GITHUB_ENV
          echo "openwrt_tag=$(echo "${{ inputs.releases_branch }}" | tr ':' '_')" >> $GITHUB_ENV

      - name: Build Image
        id: build
        run: |
          chmod +x ${IMAGEBUILDER_SH}

          for dev in ${{ steps.devices.outputs.devices }}; do
            sudo bash telegram.sh --update "${{ steps.telegram.outputs.message_id }}" "$dev" "ðŸ’¿ Building"
            if sudo bash ${IMAGEBUILDER_SH} ${{ env.openwrt_version }} "$dev"; then
              sudo bash telegram.sh --update "${{ steps.telegram.outputs.message_id }}" "$dev" "âœ… Success"
            else
              echo "Build failed! Check build.log for details"
              sudo bash telegram.sh --update "${{ steps.telegram.outputs.message_id }}" "$dev" "âŒ Failed"
            fi
          done

      - name: Upload to Release
        if: ${{ steps.build.outputs.status == 'âœ… Success' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: imagebuilder/out_firmware/*
          tag: ${{ env.openwrt_tag }}-${{ env.datetime }}
          release_name: RTA-WRT - ${{ env.openwrt_tag }}-${{ env.datetime }}
          overwrite: true
          prerelease: ${{ github.ref_name == 'dev' }}
          promote: ${{ github.ref_name != 'dev' }}
          body: |
            ---
  
            # ðŸš€ **RTA-WRT - Image Information**
                
            ---
                
            ### ðŸ“¥ **Download Statistics**
                
            ![GitHub Downloads](https://img.shields.io/github/downloads/rizkikotet-dev/RTA-WRT/${{ env.openwrt_tag }}-${{ env.datetime }}/total?style=for-the-badge&logo=Openwrt)
                
            ---
                
            ### ðŸ“¢ **Telegram Support**
                
            [![Channel](https://img.shields.io/badge/Telegram-Channel-%23059dfa?style=for-the-badge&logo=Telegram&link=https%3A%2F%2Ft.me%2Frtawrt)](https://t.me/rtawrt)
            [![Group](https://img.shields.io/badge/Telegram-Group-%23059dfa?style=for-the-badge&logo=Telegram&link=https%3A%2F%2Ft.me%2Fbackup_rtawrt)](https://t.me/backup_rtawrt)
            [![Personal](https://img.shields.io/badge/Telegram-Personal-%23059dfa?style=for-the-badge&logo=Telegram&link=https%3A%2F%2Ft.me%2FRizkiKotet)](https://t.me/RizkiKotet)
                
            ---
              
            ### ðŸ“ **Changelog**
  
            ${{ steps.changelog.outputs.changelog }}
                
            ---
                
            ## âš ï¸ Peringatan untuk Instalasi Pertama
            > **Catatan:** Booting awal memerlukan waktu agak lama karena proses partisi ulang dan konfigurasi tambahan.
  
            ---
  
            ## ðŸ“± Device yang Didukung
  
            ### Amlogic
            - **s905x** (HG680P, B860Hv1/v2) | Mod Boot SDCARD
            - **s905x2** (HG680FJ, B860Hv5, MNC CYBORG001, X96Max-4G, X96Max-2G, MECOOL-KM3-4G, Tanix-Tx5-Max, A95X-F2)
            - **s905x3** (X96-Max+, HK1-Box, Vontar-X3, H96-Max-X3, Ugoos-X3, TX3(QZ), TX3(BZ), X96-Air, X96-Max+_A100, A95X-F3-Air, Tencent-Aurora-3Pro(s905x3-b), X96-Max+Q1, X96-Max+100W, X96-Max+_2101, Infinity-B32, Whale, X88-Pro-X3, X99-Max-Plus, Transpeed-X3-Plus)
            - **s905x4** (AKARI AX810, dll)
            - **s912** (Tanix-TX8-Max, Tanix-TX9-Pro(3G), Tanix-TX9-Pro(2G), Tanix-TX92, Nexbox-A1, Nexbox-A95X-A2, A95X, H96-Pro-Plus, VORKE-Z6-Plus, Mecool-M8S-PRO-L, Vontar-X92, T95Z-Plus, Octopus-Planet, Phicomm-T1, TX3-Mini, OneCloudPro-V1.1_V1.2)
  
            ### Allwinner
            - **H5** (Orange Pi Zero Plus 2, Orange Pi Zero Plus, Orange Pi Prime, Orange Pi PC2)
            - **H6** (Orange Pi 1 Plus, Orange Pi Lite 2, Orange Pi 3 LTS, Orange Pi 3)
            - **H616** (Orange Pi Zero 2)
            - **H618** (Orange Pi Zero 3, Orange Pi Zero 2W)
  
            ### Rockchip
            - **RK3566** (Orange Pi 3B)
            - **RK3588S** (Orange Pi 5)
            - **RK3588** (Orange Pi 5 Plus)
  
            ### Broadcom
            - **BCM2710** (Raspberry Pi 3A+/3B/3B+/CM3/Zero2/Zero2W - 64bit)
            - **BCM2711** (Raspberry Pi 4B/400/CM4 - 64bit)
  
            ### Generic
            - **x86-64**
  
            ---
  
            ## â„¹ï¸ Informasi Sistem
            - **IP Default:** 192.168.1.1
            - **Username:** root
            - **Password:** rtawrt
            - **SSID:** RTA-WRT_2g / RTA-WRT_5g
  
            ### â­ Fitur Utama
            - Modemmanager dengan koneksi ulang otomatis
            - OpenClash dengan MetaCubeX Mihomo terbaru
            - Passwall *Tunneling* alternatif
            - MihomoTProxy *Tunneling* alternatif
            - TinyFm file manager
            - Internet Detector dan Lite Watchdog
            - Tema Argon & Material dengan tampilan login kustom
            - 3ginfo lite, Modeminfo, sms-tool, dan aplikasi modem lainnya
            - Dukungan Layar OLED (teruji di Raspberry Pi 4B)
  
            ---
                
            **ðŸš€ Tetap terhubung, nikmati performa maksimal dengan RTA-WRT! ðŸš€**
                
            ---

  opsional:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Install Dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y ${{ env.APT_PACKAGES }}

      - name: Add changelog info to new release description
        id: changelog
        shell: bash
        run: |
          r=$(awk '/^\*\*Changelog\*\*/ {if(found) exit; found=1} found' ${PWD}/CHANGELOG.md)
          r="${r//'%'/'%25'}"
          r="${r//$'\n'/'%0A'}"
          r="${r//$'\r'/'%0D'}"  
          echo "changelog=$r" >> $GITHUB_OUTPUT 

      - name: Change Branch
        uses: actions/checkout@v4
        with:
          ref: info

      - name: Setup Environment
        id: environment
        run: |
          set -euxo pipefail
          sudo timedatectl set-timezone "$TZ"
          echo "datetime=$(date +'%d-%m-%Y')" >> $GITHUB_ENV
          echo "openwrt_version=${{ inputs.releases_branch }}" >> $GITHUB_ENV
          echo "openwrt_tag=$(echo "${{ inputs.releases_branch }}" | tr ':' '_')" >> $GITHUB_ENV

      - name: Update Branch Info
        id: update
        run: |
          r=$(awk '/^\*\*Changelog\*\*/ {if(found) exit; found=1} found && NF' "${{ steps.changelog.outputs.changelog }}")
          r=$(echo "$r" | sed -e 's/%/%25/g' -e 's/$/\n/g' -e 's/\r/%0D/g')
          echo "changelog=$r" >> $CURRENT_BRANCH/changelog.txt
          echo "${{ env.openwrt_tag }}--$( [ "$CURRENT_BRANCH" == "main" ] && echo "main" || echo "dev" )" > $CURRENT_BRANCH/version.txt
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add . || echo "No files to commit"
          git commit -m "Auto Release: v${{ env.openwrt_version }}" || echo "No changes to commit"
          git push || echo "Error pushing to GitHub"

      - name: Notify Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          MESSAGE_THREAD_ID: 36
        run: |
          DATETIME=${{ env.datetime }}
          OPENWRT_VERSION=${{ env.openwrt_version }}
  
          # Escape karakter untuk MarkdownV2
          FORMATTED_DATETIME=$(echo "$DATETIME" | sed 's/-/\\-/g')
          FORMATTED_OPENWRT_VERSION=$(echo "$OPENWRT_VERSION" | sed 's/:/\\:/g' | sed 's/-/\\-/g' | sed 's/\./\\./g')
  
          MESSAGE_STABLE=$(printf "ðŸŽ¯ *RTA\-WRT Firmware Update*\n"
            "âœ… _Stable Release_\n\n"
            "ðŸ”¹ *Versi:* \`${FORMATTED_OPENWRT_VERSION}\`\n"
            "ðŸ”¹ *Tanggal:* \`${FORMATTED_DATETIME}\`\n\n"
            "ðŸ“Œ *Catatan:*\n"
            "ðŸ”’ Versi stabil dengan peningkatan keamanan dan performa\!\n"
            "ðŸ“¢ Disarankan untuk semua pengguna agar mendapatkan pengalaman terbaik\!\n"
          )
  
          MESSAGE_DEV=$(printf "ðŸš€ *RTA\-WRT Firmware Update*\n"
            "ðŸŒŸ _Development Release_\n\n"
            "ðŸ”¹ *Versi:* \`${FORMATTED_OPENWRT_VERSION}\`\n"
            "ðŸ”¹ *Tanggal:* \`${FORMATTED_DATETIME}\`\n\n"
            "ðŸ“Œ *Catatan:*\n"
            "ðŸ”¥ Pastikan untuk mencadangkan konfigurasi sebelum pembaruan\!\n"
            "ðŸ”„ Selalu gunakan versi terbaru untuk performa terbaik\!\n"
          )
  
          BUTTONS_STABLE='{
              "inline_keyboard": [
                  [
                      {"text": "ðŸ“¥ Unduh Firmware", "url": "https://github.com/rizkikotet-dev/RTA-WRT/releases/latest"},
                      {"text": "ðŸ“– Changelog", "url": "https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/info/main/changelog.txt"}
                  ]
              ]
          }'
  
          BUTTONS_DEV='{
              "inline_keyboard": [
                  [
                      {"text": "ðŸ“¥ Unduh Firmware", "url": "https://github.com/rizkikotet-dev/RTA-WRT/releases"},
                      {"text": "ðŸ“– Changelog", "url": "https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/info/dev/changelog.txt"}
                  ]
              ]
          }'
  
          if [ "${{ inputs.notify }}" == "true" ]; then
            if [ "${{ env.CURRENT_BRANCH }}" == "main" ]; then
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=$MESSAGE_STABLE" \
                -d "parse_mode=MarkdownV2" \
                -d "reply_markup=$BUTTONS_STABLE" || exit 1
            else
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=$MESSAGE_DEV" \
                -d "parse_mode=MarkdownV2" \
                -d "reply_markup=$BUTTONS_DEV" || exit 1
            fi
          fi
          # -d "message_thread_id=$MESSAGE_THREAD_ID"

      - name: Delete workflow runs
        if: always()
        continue-on-error: true
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0